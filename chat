provider "azurerm" {
  features {}
}

provider "azapi" {
  # Configure the AzAPI provider if necessary
}

# Assuming you have the primary and replica PostgreSQL flexible servers defined
data "azurerm_postgresql_flexible_server" "primary" {
  name                = "primary-server-name"
  resource_group_name = "primary-resource-group"
}

resource "azurerm_postgresql_flexible_server" "replica" {
  name                = "replica-server-name"
  resource_group_name = "replica-resource-group"
  location            = "your-location"
  # Other necessary properties
}

# Using azapi_resource to create the virtual endpoint
resource "azapi_resource" "postgres_virtual_endpoint" {
  type      = "Microsoft.DBforPostgreSQL/flexibleServers/virtualEndpoints@2021-06-01-preview"
  parent_id = azurerm_postgresql_flexible_server.replica.id
  name      = "pg-test"

  body = jsonencode({
    properties = {
      endpointType = "ReadWrite-members"
      serverName   = data.azurerm_postgresql_flexible_server.primary.name
    }
  })

  depends_on = [azurerm_postgresql_flexible_server.replica]
}

output "virtual_endpoint_id" {
  value = azapi_resource.postgres_virtual_endpoint.id
}
