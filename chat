import psycopg2
import pandas as pd

# UAT Database Connection
uat_conn = psycopg2.connect(
    host="UAT_DB_HOST",
    database="UAT_DB_NAME",
    user="UAT_DB_USER",
    password="UAT_DB_PASSWORD"
)

# Local Database Connection
local_conn = psycopg2.connect(
    host="localhost",
    database="LOCAL_DB_NAME",
    user="LOCAL_DB_USER",
    password="LOCAL_DB_PASSWORD"
)

def fetch_data_from_uat(query):
    # Read data from UAT database
    uat_df = pd.read_sql(query, uat_conn)
    return uat_df

def load_data_to_local(dataframe, table_name):
    cursor = local_conn.cursor()
    
    for index, row in dataframe.iterrows():
        # Create insert query dynamically, example for inserting into `table_name`
        insert_query = f"INSERT INTO {table_name} (col1, col2, col3) VALUES (%s, %s, %s)"
        cursor.execute(insert_query, tuple(row))
    
    # Commit the transaction to local database
    local_conn.commit()
    cursor.close()

# Example Usage
try:
    # 1. Extract data from UAT database
    query = "SELECT col1, col2, col3 FROM your_table"
    data_from_uat = fetch_data_from_uat(query)

    # 2. Load data into local database
    load_data_to_local(data_from_uat, 'your_table')

    print("Data migration completed successfully!")

except Exception as e:
    print(f"Error occurred: {e}")

finally:
    # Close connections
    uat_conn.close()
    local_conn.close()
